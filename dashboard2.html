<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Binary Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.18) 0, transparent 50%),
        radial-gradient(circle at 100% 0%, rgba(139, 92, 246, 0.2) 0, transparent 55%),
        #020617;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1100px;
      padding: 24px 16px 40px;
      box-sizing: border-box;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .brand-title h1 {
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .logo-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        #22d3ee,
        #a855f7,
        #22c55e,
        #eab308,
        #22d3ee
      );
      box-shadow: 0 0 16px rgba(56, 189, 248, 0.9);
    }

    .brand-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }

    .header-chip {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
    }

    .header-chip span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.9);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.98));
      border-radius: 18px;
      padding: 20px 24px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(18px);
      margin-bottom: 18px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    h2 {
      margin: 0;
      font-size: 1.1rem;
      color: #e5e7eb;
    }

    h3 {
      margin: 0;
      font-size: 0.95rem;
      color: #e5e7eb;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
    }

    .badge-pill {
      padding: 5px 11px;
    }

    .badge-primary {
      border-color: rgba(56, 189, 248, 0.7);
      color: #e0f2fe;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.2), rgba(15, 23, 42, 0.98));
    }

    .badge-success {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: radial-gradient(circle at top, rgba(34, 197, 94, 0.2), rgba(15, 23, 42, 0.98));
    }

    .badge-danger {
      border-color: rgba(239, 68, 68, 0.7);
      color: #fecaca;
      background: radial-gradient(circle at top, rgba(239, 68, 68, 0.2), rgba(15, 23, 42, 0.98));
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #94a3b8;
      margin-bottom: 2px;
    }

    .value-lg {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .muted {
      color: #9ca3af;
      font-size: 0.85rem;
    }

    .file-name {
      padding: 2px 7px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.8rem;
    }

    .upload-area {
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      cursor: pointer;
      transition: border-color 0.12s ease, background 0.12s ease;
    }

    .upload-area:hover {
      border-color: rgba(56, 189, 248, 0.8);
      background: rgba(15, 23, 42, 1);
    }

    .upload-text-main {
      font-size: 0.95rem;
      color: #e5e7eb;
    }

    .upload-text-sub {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .upload-button {
      border-radius: 999px;
      padding: 7px 16px;
      border: none;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #22d3ee, #a855f7);
      color: #0b1120;
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }

    .upload-button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .upload-button:not(:disabled):active {
      transform: translateY(1px);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5);
    }

    .status-line {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #6b7280;
    }

    .status-dot.loading {
      background: #38bdf8;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.9);
      animation: pulse 1.4s infinite ease-in-out;
    }

    .status-dot.success {
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .status-dot.error {
      background: #ef4444;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.9);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.6; }
      50% { transform: scale(1.3); opacity: 1; }
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .chip span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #38bdf8;
    }

    .chip-secondary .dot { background: #a855f7; }
    .chip-tertiary .dot { background: #f97316; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      text-align: left;
      padding: 6px 6px;
    }

    th {
      font-weight: 600;
      color: #a5b4fc;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
    }

    tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.7);
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.95);
    }

    ol {
      padding-left: 18px;
      margin: 6px 0 0;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    @media (max-width: 640px) {
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .card {
        padding: 14px 16px;
      }
      .brand-title h1 {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- HEADER -->
    <div class="header-row">
      <div class="brand">
        <div class="brand-title">
          <div class="logo-dot"></div>
          <h1>Crypto Binary Analysis</h1>
        </div>
        <div class="brand-subtitle">GNN • LSTM • XGBoost • OC-SVM</div>
      </div>
      <div class="header-chip">
        <span class="dot"></span>
        Real-time model inference
      </div>
    </div>

    <!-- UPLOAD / CONTROL CARD -->
    <div class="card">
      <div class="card-header">
        <h2>Upload Firmware / Binary</h2>
        <span class="badge badge-primary">Step 1 · Select file</span>
      </div>

      <div>
        <label class="upload-area" for="binaryFile">
          <div>
            <div class="upload-text-main">Drop a binary file here or click to browse</div>
            <div class="upload-text-sub">Typical formats: <code>.bin</code>, <code>.elf</code>, firmware blobs, etc.</div>
          </div>
          <button type="button" class="upload-button" id="browseBtn">
            Browse…
          </button>
        </label>
        <input type="file" id="binaryFile" accept=".bin,.elf,.exe,.dat,*/*" hidden />

        <div class="status-line">
          <div class="status-dot" id="statusDot"></div>
          <span class="muted" id="statusText">No file selected yet.</span>
        </div>

        <div style="margin-top: 10px; display:flex; justify-content:flex-end;">
          <button class="upload-button" id="analyzeBtn" disabled>
            Run Crypto Analysis
          </button>
        </div>
      </div>
    </div>

    <!-- TOP SUMMARY CARD -->
    <div class="card">
      <div class="card-header">
        <div>
          <h3>Analysis Summary</h3>
          <div class="muted">
            File: <span id="fileName" class="file-name">–</span>
          </div>
        </div>
        <div>
          <span class="badge badge-primary badge-pill" id="algoBadge">Algorithm • pending</span>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="label">Predicted Algorithm</div>
          <div class="value-lg" id="algoName">–</div>
          <div class="muted" id="algoId">(id = –)</div>
        </div>

        <div>
          <div class="label">Architecture</div>
          <div class="value-lg" id="archName">–</div>
        </div>

        <div>
          <div class="label">Protocol</div>
          <div class="value-lg" id="protoName">–</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <span id="proprietaryBadge" class="badge badge-pill">Not analyzed</span>
      </div>
    </div>

    <!-- MODEL VOTES -->
    <div class="card">
      <div class="card-header">
        <h2>Model Votes (Algorithm ID)</h2>
        <span class="badge">Ensemble decision</span>
      </div>
      <div class="grid">
        <div>
          <div class="chip">
            <span class="dot"></span>
            <span>GNN</span>
            <span style="margin-left:auto;" id="gnnVote">–</span>
          </div>
        </div>
        <div>
          <div class="chip chip-secondary">
            <span class="dot"></span>
            <span>LSTM</span>
            <span style="margin-left:auto;" id="lstmVote">–</span>
          </div>
        </div>
        <div>
          <div class="chip chip-tertiary">
            <span class="dot"></span>
            <span>XGBoost (Algo)</span>
            <span style="margin-left:auto;" id="xgbVote">–</span>
          </div>
        </div>
      </div>
      <p class="muted" style="margin-top: 10px;">
        Final crypto algorithm is selected by majority vote across GNN, LSTM, and XGBoost classifiers.
      </p>
    </div>

    <!-- PROTOCOL SEQUENCE -->
    <div class="card">
      <div class="card-header">
        <h2>Protocol Handshake Flow</h2>
        <span class="badge">From learned dataset</span>
      </div>
      <div id="protoStepsWrapper">
        <ol id="protoSteps">
          <li class="muted">No binary analyzed yet.</li>
        </ol>
      </div>
    </div>

    <!-- FEATURE COMPARISON -->
    <div class="card">
      <div class="card-header">
        <h2>Feature Profile</h2>
        <span class="badge">Current vs. typical for predicted algorithm</span>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Current Binary</th>
              <th>Typical (Training Mean)</th>
            </tr>
          </thead>
          <tbody id="featureTableBody">
            <tr>
              <td colspan="3" class="muted">Run an analysis to populate feature statistics.</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top: 8px;">
        Features are computed directly from raw bytes (length, entropy, byte statistics), then compared to the
        average profile of binaries for the predicted crypto algorithm.
      </p>
    </div>
  </div>

  <script>
    // ---------------------------------------------------------------------
    // CONFIG: adjust API URL if needed (e.g., "http://127.0.0.1:5000")
    // ---------------------------------------------------------------------
    const API_URL = "/api/predict_file";

    const fileInput = document.getElementById("binaryFile");
    const browseBtn = document.getElementById("browseBtn");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");

    let selectedFile = null;

    // Open file dialog when clicking fancy button or whole upload area.
    browseBtn.addEventListener("click", () => fileInput.click());
    document.querySelector(".upload-area").addEventListener("click", (e) => {
      // Only trigger if they didn’t click directly on the button (it already triggers)
      if (e.target !== browseBtn) {
        fileInput.click();
      }
    });

    fileInput.addEventListener("change", () => {
      if (fileInput.files && fileInput.files[0]) {
        selectedFile = fileInput.files[0];
        analyzeBtn.disabled = false;
        setStatus("ready", `Selected file: ${selectedFile.name}`);
      } else {
        selectedFile = null;
        analyzeBtn.disabled = true;
        setStatus("idle", "No file selected yet.");
      }
    });

    analyzeBtn.addEventListener("click", async () => {
      if (!selectedFile) return;

      analyzeBtn.disabled = true;
      setStatus("loading", "Running crypto analysis…");

      try {
        const formData = new FormData();
        formData.append("file", selectedFile);

        const response = await fetch(API_URL, {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || `HTTP ${response.status}`);
        }

        const data = await response.json();
        renderDashboard(data);
        setStatus("success", "Analysis complete.");
      } catch (err) {
        console.error(err);
        setStatus("error", "Analysis failed. Check console / backend logs.");
      } finally {
        analyzeBtn.disabled = false;
      }
    });

    function setStatus(mode, text) {
      statusDot.className = "status-dot";
      if (mode === "loading") statusDot.classList.add("loading");
      else if (mode === "success") statusDot.classList.add("success");
      else if (mode === "error") statusDot.classList.add("error");
      statusText.textContent = text;
    }

    // ---------------------------------------------------------------------
    // RENDER FUNCTION (uses your predict_for_binary JSON format)
    // ---------------------------------------------------------------------
    function renderDashboard(res) {
      // --- Top summary ---
      document.getElementById("fileName").textContent = res.file || (selectedFile ? selectedFile.name : "unknown.bin");
      document.getElementById("algoName").textContent = res.algo_name ?? "unknown";
      document.getElementById("algoId").textContent = `(id = ${res.algo_id ?? "–"})`;
      document.getElementById("archName").textContent = res.arch_name ?? "unknown";
      document.getElementById("protoName").textContent = res.protocol_name ?? "unknown";

      // Proprietary / standard-like badge
      const propBadge = document.getElementById("proprietaryBadge");
      propBadge.classList.remove("badge-success", "badge-danger");
      if (res.ocsvm_is_proprietary) {
        propBadge.textContent = "Proprietary / Outlier";
        propBadge.classList.add("badge-danger");
      } else {
        propBadge.textContent = "Standard-like";
        propBadge.classList.add("badge-success");
      }

      // Algorithm badge
      const algoBadge = document.getElementById("algoBadge");
      algoBadge.textContent = `${res.algo_name ?? "Algorithm"} • Crypto Algorithm`;

      // --- Model votes ---
      document.getElementById("gnnVote").textContent = res.gnn_pred_algo_id ?? "–";
      document.getElementById("lstmVote").textContent = res.lstm_pred_algo_id ?? "–";
      document.getElementById("xgbVote").textContent = res.xgb_algo_pred_algo_id ?? "–";

      // --- Protocol steps ---
      const stepsContainer = document.getElementById("protoSteps");
      stepsContainer.innerHTML = "";
      const protoSeq = res.protocol_sequence && res.protocol_sequence.length
        ? res.protocol_sequence
        : ["<no sequence in dataset>"];
      protoSeq.forEach(step => {
        const li = document.createElement("li");
        li.textContent = step;
        stepsContainer.appendChild(li);
      });

      // --- Feature table ---
      const featureOrder = ["length", "unique_bytes", "entropy", "mean_byte", "std_byte"];
      const algoMean = res.algo_mean_features || [];
      const featureTableBody = document.getElementById("featureTableBody");
      featureTableBody.innerHTML = "";

      if (!res.input_features) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.className = "muted";
        td.textContent = "No feature statistics available.";
        tr.appendChild(td);
        featureTableBody.appendChild(tr);
        return;
      }

      featureOrder.forEach((name, idx) => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = name;
        tr.appendChild(tdName);

        const tdCurrent = document.createElement("td");
        const currentVal = res.input_features[name];
        tdCurrent.textContent = currentVal !== undefined ? currentVal : "-";
        tr.appendChild(tdCurrent);

        const tdMean = document.createElement("td");
        const meanVal = algoMean[idx];
        tdMean.textContent = meanVal !== undefined ? meanVal : "-";
        tr.appendChild(tdMean);

        featureTableBody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
